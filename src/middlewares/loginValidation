const { body } = require('express-validator');
const db = require("../database/models");
const bcrypt = require('bcryptjs')

module.exports = [

    body('contrasenia').exists().notEmpty().withMessage('La contraseña no debe ser vacia.'),
    body('email').exists().notEmpty().withMessage('No puede ser vacio').isEmail().withMessage('Indicá un email').custom(async (value, { req }) => {
        const user = await db.User.findAll({ where: { email: value } }).then(usuarios => usuarios[0]);
        if (!user) {
            throw new Error('El correo no esta registrado')
        }
        if (await bcrypt.compare(req.body.contrasenia, user.password)) {
            delete user.password;
            req.session.userLog = user;
            if (req.body.cookie) {
                res.cookie("recordame", user.email, { maxAge: 1000 * 60 * 60 })
            }
        } else {
            throw new Error('Contraseña incorrecta')
        }
    })

]